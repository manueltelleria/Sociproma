<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title>[% titulo %]</title>
<!-- hojas de estilo generales -->
[% INCLUDE estilosgenerales.tt %]


<!-- archivos de javascript para Prototype -->
<script type="text/javascript" src="[%ruta_estatica%]/js/prototype/prototype.js"></script>

<!-- archivos de javascript generales (cargar en todas las pÃ¡ginas) -->
[% INCLUDE jsgenerales.tt %]

[% formbuilder.jshead %]

<script language="JavaScript">

function validate_forma2 (form) {
    var alertstr = '';
    var invalid  = 0;
    var invalid_fields = new Array();

  // id_usuario: standard text, hidden, password, or textarea box
    var id_usuario = form.elements['id_usuario'].value;
    if (id_usuario == null || ! id_usuario.match(/^-?\s*[0-9]+\.?[0-9]*$|^-?\s*\.[0-9]+$/)) {
        alertstr += '- Indique un valor válido para el campo "Cédula"\n';
        invalid++;
        invalid_fields.push('id_usuario');
    }

    // id_unidadesadmin: select list, always assume it's multiple to get all values
    var id_unidadesadmin = null;
    var selected_id_unidadesadmin = 0;
    for (var loop = 0; loop < form.elements['id_unidadesadmin'].options.length; loop++) {
        if (form.elements['id_unidadesadmin'].options[loop].selected) {
            id_unidadesadmin = form.elements['id_unidadesadmin'].options[loop].value;
            selected_id_unidadesadmin++;
            if (id_unidadesadmin == null || id_unidadesadmin === "") {
                alertstr += '- Seleccione una opción para el campo "Unidades Administrativa"\n';
                invalid++;
                invalid_fields.push('id_unidadesadmin');
            }
        } // if
    } // for id_unidadesadmin
    if (! selected_id_unidadesadmin) {
        alertstr += '- Seleccione una opción para el campo "Unidades Administrativa"\n';
        invalid++;
    }

    if (! form.check.checked == true) {
        alertstr += '- La cédula no pertenece a ningun funcionario\n';
        invalid++;
    }

    if (invalid > 0 || alertstr != '') {
        if (! invalid) invalid = 'The following';   // catch for programmer error
        alert(''+invalid+' error(es) fueron encontrados al aceptar la información:'+'\n\n'
                +alertstr+'\n'+'- Por favor corrija los campos y trate de nuevo');
        return false;
    }
    return true;  // all checked ok
}
//-->
</script>


<script language="JavaScript">

function buscarFuncionario(id_usuario){

    var url = '[% ruta_buscar %]';
    var funcion = eval('mostrarFuncionario');
    
    if (id_usuario){
    var pars = "id_usuario="+id_usuario;
    var myAjax = new Ajax.Request( url, { method: 'post', parameters: pars , onComplete: funcion});
  }
    

}

function mostrarFuncionario(originalRequest){
    var respuesta = originalRequest.responseText;
    var forma = document.datosbasicos;
    if ( respuesta != 'undef' ){
        document.getElementById('nombreFuncionario').innerHTML = respuesta;
        if (respuesta != 'Formato no valido para c&eacute;dula' && respuesta != 'No encontrado'){
            document.forma.check.checked = true;
        }else{
            document.forma.check.checked = false;
        }
    }
}
</script>

<script language="javascript">

function upd(usuario,unidad, ruta){
  document.forma.id_usuario.value = usuario;
  document.forma.id_unidadesadmin.value = unidad;
  document.forma.action = ruta;
  document.forma.submit();
}

function buscar(usuario, unidad){
    document.forma.id_usuario.value = usuario;
    document.forma.id_unidadesadmin.value = unidad;
    buscarFuncionario(document.forma.id_usuario.value);
}

</script>

</head>
<body  onload="cargarMenu()">
[% INCLUDE encabezado.tt %]
<fieldset>
<legend>Administrar Usuarios/Unidades</legend>
<!-- Login form -->
[% formbuilder.start %]
[% formbuilder.statetags %]
[% formbuilder.keepextras %]
[% INCLUDE jscargarmenu.tt %]
     <table align="center" border="0" cellspacing="1" cellpadding="2">
        <tr>
            <td align="center" colspan="4" class="titulodonforojo">Administrar Usuarios/Unidades</td>
        </tr>
        <tr>
            <td align="left" class="fondoetiqueta" nowrap>[% formbuilder.field.id_usuario.label %]</td>
            <td colspan = 3><table><td>[% formbuilder.field.id_usuario.field %]</td><td> <b><div id='nombreFuncionario'></div></b></td><td><input type=checkbox  name=check disabled=true></td></table></td>
        </tr>
        <tr>
            <td align="left" class="fondoetiqueta" nowrap>[% formbuilder.field.id_unidadesadmin.label %]</td><td>[% formbuilder.field.id_unidadesadmin.field %]</td>
        </tr>
        <tr>
            <td class="" nowrap align=center colspan=4>
            <input type=button  onclick="javascript: if(validate_forma2(document.forma)){document.forma.flag.value=0; upd(document.forma.id_usuario.value,document.forma.id_unidadesadmin.value,'/presupuesto/administracion/formuladores/editarFormuladores')}" value='Vincular'/>
            </td>
        </tr>
        <tr>
            <td colspan="11">
        <table align="left" width="100%" border="0">
        <tr>
            <td width="20%" class="fondoetiqueta" align="left" colspan="2">
            <b>[% formbuilder.field.criterio.label %]</b></td>
            <td align="left" valign="middle" colspan=9>[% formbuilder.field.criterio.field %]&nbsp;<img src="[% ruta_estatica %]/imagenes/menu/help.gif" onmouseover="Tip('<b>Criterio de Búsqueda</b><br>Debe especificar un parámetro que concuerden con los campos:<br>Cédula y Nombre de la Unidad')" onmouseout="UnTip()" />&nbsp;&nbsp;[% formbuilder.submit %]</td>
        </tr>
        </table>
    </td>
        </tr>
        <tr class=titulodonforojo>
            <th width=45 colspan=12>Usuarios Autorizados por Unidad</th>
        </tr>
        <tr class=fondoetiqueta5>
            <th width=40>C&eacute;dula de Identidad</th>
            <th width=300>Nombre del Funcionario</th>
            <th width=200>Unidad administrativa</th>
            <th width=80>Desvincular</th>

        </tr>
        [% FOREACH field IN tabla %]
        <tr class="[% field.clase %]">
            <td align="center"><a style="text-decoration:none" href="javascript: buscar('[% field.id_usuario %]','[% field.id_unidadesadmin %]')">[% field.id_usuario %]</a></td>
            <td align="center">[% field.usuario %]</td>
            <td align="center">[% field.unidadesadmin %]</td>

            <td align=center><a style="text-decoration:none" href="javascript:if (confirm('¿Desea eliminar el registro?'))upd([% field.id_usuario %],[% field.id_unidadesadmin %],'/presupuesto/administracion/formuladores/eliminarVinculo')"><IMG src="/static/imagenes/menu/undo.gif" border="0"></a></td>
            [% END %]
        </tr>
      </table>
[% formbuilder.field.flag.field %]
[% formbuilder.end %]
</fieldset>
</body>
</html>